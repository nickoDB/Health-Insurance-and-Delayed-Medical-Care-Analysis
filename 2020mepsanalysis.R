# Load required packages 
install.packages("survey")
install.packages("dplyr")
install.packages("haven")
install.packages("FNN")
library(FNN)
library(survey)
library(dplyr)
library(haven)
library(broom)
library(dplyr)
library(caret)
library(class)

# Download and load MEPS 2020 data
url <- "https://meps.ahrq.gov/mepsweb/data_files/pufs/h224/h224dta.zip"
temp <- tempfile()
download.file(url, temp)
meps_file <- unzip(temp, exdir = tempdir())
fyc20 <- read_dta(meps_file[1])
# : Preview the data to pick variables 
colnames(fyc20)
# View relevant variables 
fyc20 %>%
  select(DUPERSID, DLAYCA42, AGELAST, SEX, RACETHX, INSCOV20, REGION53, HIDEG, INTVLANG)
# Keep only needed variables 
fyc20_sub <- fyc20 %>%
  select(DUPERSID, VARPSU, VARSTR, PERWT20F,
         DLAYCA42, AGELAST, SEX, RACETHX, INSCOV20, REGION53, HIDEG, INTVLANG)
# Create variables 
fyc20x <- fyc20_sub %>%
  mutate(
    DLAYCA42 = as.numeric(DLAYCA42),
    # Convert outcome from 1/2 to 0/1
    delay_medical = case_when(
      DLAYCA42 == 1 ~ 1,
      DLAYCA42 == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    # Create subpopulation flag
    subpop = !is.na(delay_medical)
  )
# QC new variables
fyc20x %>% count(delay_medical, DLAYCA42, subpop)
# Check regression predictors 
fyc20x %>% count(SEX)
# 1 = MALE, 2 = FEMALE
fyc20x %>% count(RACETHX)
# 1 = HISPANIC
# 2 = NON-HISPANIC WHITE
# 3 = NON-HISPANIC BLACK
# 4 = NON-HISPANIC ASIAN
# 5 = NON-HISPANIC OTHER/MULTIPLE
fyc20x %>% count(INSCOV20)
# 1 = ANY PRIVATE
# 2 = PUBLIC ONLY
# 3 = UNINSURED
fyc20x %>% count(REGION53)
# 1 = NORTHEAST
# 2 = MIDWEST
# 3 = SOUTH
# 4 = WEST
fyc20x %>% count(HIDEG)
# Educational attainment categories
fyc20x %>% count(INTVLANG)
# 1 = ENGLISH, 2 = SPANISH, 3 = OTHER
fyc20x %>% pull(AGELAST) %>% summary
# Define the survey design
meps_dsgn <- svydesign(
  id = ~VARPSU,
  strata = ~VARSTR,
  weights = ~PERWT20F,
  data = fyc20x,
  nest = TRUE
)
# Survey-weighted estimate (cleaning) 
svymean(~delay_medical, design = subset(meps_dsgn, subpop))
# Logistic regression: medical delay by insurance type and predictors
logit_model <- svyglm(
  delay_medical ~ AGELAST + as.factor(SEX) + as.factor(RACETHX) +
    as.factor(INSCOV20) + as.factor(REGION53) + as.factor(HIDEG) + as.factor(INTVLANG),
  design = subset(meps_dsgn, subpop),
  family = quasibinomial
)
summary(logit_model)
#  Create and relabel tidy_model
tidy_model <- tidy(logit_model) %>%
  mutate(term = recode(term,
                       `(Intercept)` = "Intercept",
                       `AGELAST` = "Age (last)",
                       `as.factor(SEX)2` = "Sex: Female",
                       `as.factor(RACETHX)2` = "Race: White",
                       `as.factor(RACETHX)3` = "Race: Black",
                       `as.factor(RACETHX)4` = "Race: Asian",
                       `as.factor(RACETHX)5` = "Race: Other/Mixed",
                       `as.factor(INSCOV20)2` = "Insurance: Public",
                       `as.factor(INSCOV20)3` = "Insurance: Uninsured",
                       `as.factor(REGION53)1` = "Region: Northeast",
                       `as.factor(REGION53)2` = "Region: Midwest",
                       `as.factor(REGION53)3` = "Region: South",
                       `as.factor(REGION53)4` = "Region: West",
                       `as.factor(HIDEG)-8` = "Education: DK",
                       `as.factor(HIDEG)-7` = "Education: Refused",
                       `as.factor(HIDEG)1` = "Education: No Degree",
                       `as.factor(HIDEG)2` = "Education: GED",
                       `as.factor(HIDEG)3` = "Education: HS Diploma",
                       `as.factor(HIDEG)4` = "Education: Bachelor's",
                       `as.factor(HIDEG)5` = "Education: Master's",
                       `as.factor(HIDEG)6` = "Education: Doctorate",
                       `as.factor(HIDEG)7` = "Education: Other Degree",
                       `as.factor(HIDEG)8` = "Education: Under 16",
                       `as.factor(INTVLANG)2` = "Interview: Spanish",
                       `as.factor(INTVLANG)3` = "Interview: ENG & SP",
                       `as.factor(INTVLANG)91` = "Interview: Other"
  ))
# View cleaned model output
print(tidy_model)
library(knitr)
library(kableExtra)
tidy_model %>%
  kable(digits = 3, caption = "Survey-Weighted Logistic Regression Results") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
############################################################################
#KNN Model
#Create outcome and filter valid responses (cleaning)
fyc20_clean <- fyc20_sub %>%
  mutate(
    DLAYCA42 = as.numeric(DLAYCA42),
    delay_medical = case_when(
      DLAYCA42 == 1 ~ 1,  # Delayed care
      DLAYCA42 == 2 ~ 0,  # Did not delay
      TRUE ~ NA_real_
    )
  ) %>%
  filter(!is.na(delay_medical))  # Remove missing outcomes
# 4. Convert variables to factors
fyc20_clean <- fyc20_clean %>%
  mutate(
    delay_medical = as.factor(delay_medical),
    SEX = as.factor(SEX),
    RACETHX = as.factor(RACETHX),
    INSCOV20 = as.factor(INSCOV20),
    REGION53 = as.factor(REGION53),
    HIDEG = as.factor(HIDEG),
    INTVLANG = as.factor(INTVLANG)
  )
# smple for faster processing (optional)
set.seed(42)
fyc20_sample <- fyc20_clean %>% sample_n(500)
# 5. One-hot encode categorical variables
#One-hot encode using model.matrix (faster than dummyVars)
#5. One-hot encode using model.matrix on the sample
x_data <- model.matrix(delay_medical ~ . - 1, data = fyc20_sample) %>% as.data.frame()
y_data <- fyc20_sample$delay_medical
# 6. Split data into training and testing sets
set.seed(123)
train_index <- createDataPartition(y_data, p = 0.7, list = FALSE)
x_train <- x_data[train_index, ]
x_test  <- x_data[-train_index, ]
y_train <- y_data[train_index]
y_test  <- y_data[-train_index]
# 7. Run KNN (k = 3)
k <- 3
y_pred <- knn(train = x_train, test = x_test, cl = y_train, k = k)
# 8. Evaluate model performance
conf_matrix <- confusionMatrix(y_pred, y_test)
print(conf_matrix)
# 9. (Optional) Tune k from 1 to 20
accuracy <- c()
for (k in 1:20) {
  pred_k <- knn(train = x_train, test = x_test, cl = y_train, k = k)
  acc <- mean(pred_k == y_test)
  accuracy <- c(accuracy, acc)
}
# Plot accuracy by k
plot(1:20, accuracy, type = "b", pch = 19,
     xlab = "Number of Neighbors (k)",
     ylab = "Accuracy",
     main = "KNN Accuracy by k (MEPS 2020)")

Output 
> library(FNN)
> library(survey)
> library(dplyr)
> library(haven)
> library(broom)
> library(dplyr)
> library(caret)
Loading required package: ggplot2
Loading required package: lattice

Attaching package: ‘caret’

The following object is masked from ‘package:survival’:
  
  cluster

> library(class)
> # Download and load MEPS 2020 data -------------------------------------------
> url <- "https://meps.ahrq.gov/mepsweb/data_files/pufs/h224/h224dta.zip"
> temp <- tempfile()
> download.file(url, temp)
trying URL 'https://meps.ahrq.gov/mepsweb/data_files/pufs/h224/h224dta.zip'
Content type 'application/zip' length 7855335 bytes (7.5 MB)
==================================================
  downloaded 7.5 MB

> meps_file <- unzip(temp, exdir = tempdir())
> fyc20 <- read_dta(meps_file[1])
> # : Preview the data to pick variables 
  > colnames(fyc20)
[1] "DUID"         "PID"          "DUPERSID"     "PANEL"        "FAMID31"     
[6] "FAMID42"      "FAMID53"      "FAMID20"      "FAMIDYR"      "CPSFAMID"    
[11] "FCSZ1231"     "FCRP1231"     "RULETR31"     "RULETR42"     "RULETR53"    
[16] "RULETR20"     "RUSIZE31"     "RUSIZE42"     "RUSIZE53"     "RUSIZE20"    
[21] "RUCLAS31"     "RUCLAS42"     "RUCLAS53"     "RUCLAS20"     "FAMSZE31"    
[26] "FAMSZE42"     "FAMSZE53"     "FAMSZE20"     "FMRS1231"     "FAMS1231"    
[31] "FAMSZEYR"     "FAMRFPYR"     "REGION31"     "REGION42"     "REGION53"    
[36] "REGION20"     "REFPRS31"     "REFPRS42"     "REFPRS53"     "REFPRS20"    
[41] "RESP31"       "RESP42"       "RESP53"       "RESP20"       "PROXY31"     
[46] "PROXY42"      "PROXY53"      "PROXY20"      "INTVLANG"     "BEGRFM31"    
[51] "BEGRFY31"     "ENDRFM31"     "ENDRFY31"     "BEGRFM42"     "BEGRFY42"    
[56] "ENDRFM42"     "ENDRFY42"     "BEGRFM53"     "BEGRFY53"     "ENDRFM53"    
[61] "ENDRFY53"     "ENDRFM20"     "ENDRFY20"     "KEYNESS"      "INSCOP31"    
[66] "INSCOP42"     "INSCOP53"     "INSCOP20"     "INSC1231"     "INSCOPE"     
[71] "ELGRND31"     "ELGRND42"     "ELGRND53"     "ELGRND20"     "PSTATS31"    
[76] "PSTATS42"     "PSTATS53"     "RURSLT31"     "RURSLT42"     "RURSLT53"    
[81] "AGE31X"       "AGE42X"       "AGE53X"       "AGE20X"       "AGELAST"     
[86] "DOBMM"        "DOBYY"        "SEX"          "RACEV1X"      "RACEV2X"     
[91] "RACEAX"       "RACEBX"       "RACEWX"       "RACETHX"      "HISPANX"     
[96] "HISPNCAT"     "MARRY31X"     "MARRY42X"     "MARRY53X"     "MARRY20X"    
[101] "SPOUID31"     "SPOUID42"     "SPOUID53"     "SPOUID20"     "SPOUIN31"    
[106] "SPOUIN42"     "SPOUIN53"     "SPOUIN20"     "EDUCYR"       "HIDEG"       
[111] "FTSTU31X"     "FTSTU42X"     "FTSTU53X"     "FTSTU20X"     "ACTDTY31"    
[116] "ACTDTY42"     "ACTDTY53"     "REFRL31X"     "REFRL42X"     "REFRL53X"    
[121] "REFRL20X"     "OTHLGSPK"     "WHTLGSPK"     "HWELLSPK"     "BORNUSA"     
[126] "YRSINUS"      "MOPID31X"     "MOPID42X"     "MOPID53X"     "DAPID31X"    
[131] "DAPID42X"     "DAPID53X"     "RTHLTH31"     "RTHLTH42"     "RTHLTH53"    
[136] "MNHLTH31"     "MNHLTH42"     "MNHLTH53"     "HIBPDX"       "HIBPAGED"    
[141] "BPMLDX"       "CHDDX"        "CHDAGED"      "ANGIDX"       "ANGIAGED"    
[146] "MIDX"         "MIAGED"       "OHRTDX"       "OHRTAGED"     "OHRTTYPE"    
[151] "STRKDX"       "STRKAGED"     "EMPHDX"       "EMPHAGED"     "CHBRON31"    
[156] "CHBRON53"     "CHOLDX"       "CHOLAGED"     "CANCERDX"     "CABLADDR"    
[161] "CABLOOD"      "CABREAST"     "CACERVIX"     "CACOLON"      "CALUNG"      
[166] "CALYMPH"      "CAMELANO"     "CAOTHER"      "CAPROSTA"     "CASKINNM"    
[171] "CASKINDK"     "CAUTERUS"     "DIABDX_M18"   "DIABAGED"     "JTPAIN31_M18"
[176] "JTPAIN53_M18" "ARTHDX"       "ARTHTYPE"     "ARTHAGED"     "ASTHDX"      
[181] "ASTHAGED"     "ASSTIL31"     "ASSTIL53"     "ASATAK31"     "ASATAK53"    
[186] "ASTHEP31"     "ASTHEP53"     "ASACUT31"     "ASACUT53"     "ASMRCN31"    
[191] "ASMRCN53"     "ASPREV31"     "ASPREV53"     "ASDALY31"     "ASDALY53"    
[196] "ASPKFL31"     "ASPKFL53"     "ASEVFL31"     "ASEVFL53"     "ASWNFL31"    
[201] "ASWNFL53"     "ADHDADDX"     "ADHDAGED"     "IADLHP31"     "IADLHP53"    
[206] "ADLHLP31"     "ADLHLP53"     "AIDHLP31"     "AIDHLP53"     "WLKLIM31"    
[211] "WLKLIM53"     "LFTDIF31"     "LFTDIF53"     "STPDIF31"     "STPDIF53"    
[216] "WLKDIF31"     "WLKDIF53"     "MILDIF31"     "MILDIF53"     "STNDIF31"    
[221] "STNDIF53"     "BENDIF31"     "BENDIF53"     "RCHDIF31"     "RCHDIF53"    
[226] "FNGRDF31"     "FNGRDF53"     "ACTLIM31"     "ACTLIM53"     "WRKLIM31"    
[231] "WRKLIM53"     "HSELIM31"     "HSELIM53"     "SCHLIM31"     "SCHLIM53"    
[236] "UNABLE31"     "UNABLE53"     "SOCLIM31"     "SOCLIM53"     "COGLIM31"    
[241] "COGLIM53"     "DFHEAR42"     "DFSEE42"      "DFCOG42"      "DFWLKC42"    
[246] "DFDRSB42"     "DFERND42"     "ANYLMI20"     "CHPMED42"     "CHPMHB42"    
[251] "CHPMCN42"     "CHSERV42"     "CHSRHB42"     "CHSRCN42"     "CHLIMI42"    
[256] "CHLIHB42"     "CHLICO42"     "CHTHER42"     "CHTHHB42"     "CHTHCO42"    
[261] "CHCOUN42"     "CHEMPB42"     "CSHCN42"      "MESHGT42"     "WHNHGT42"    
[266] "MESWGT42"     "WHNWGT42"     "CHBMIX42"     "MESVIS42"     "EATHLT42"    
[271] "WHNEAT42"     "PHYSCL42"     "WHNPHY42"     "SAFEST42"     "WHNSAF42"    
[276] "BOOST42"      "WHNBST42"     "LAPBLT42"     "WHNLAP42"     "HELMET42"    
[281] "WHNHEL42"     "NOSMOK42"     "WHNSMK42"     "TIMALN42"     "LSTETH53"    
[286] "PHYEXE53"     "OFTSMK53"     "SAQELIG"      "ADPROX42"     "ADSEX42"     
[291] "ADAGE42"      "ADGENH42"     "ADDAYA42"     "ADCLIM42"     "ADACLS42"    
[296] "ADWKLM42"     "ADEMLS42"     "ADMWCF42"     "ADPAIN42"     "ADPCFL42"    
[301] "ADENGY42"     "ADPRST42"     "ADSOCA42"     "VPCS42"       "VMCS42"      
[306] "VRFLAG42"     "ADNERV42"     "ADHOPE42"     "ADREST42"     "ADSAD42"     
[311] "ADEFRT42"     "ADWRTH42"     "K6SUM42"      "ADINTR42"     "ADDPRS42"    
[316] "PHQ242"       "ADSLEEP42"    "ADKALC42"     "ADNUMDRK42"   "ADRNK542"    
[321] "ADRNK442"     "ADOFTALC42"   "ADSTAL42"     "ADMNTRT42"    "ADRATETRT42" 
[326] "ADTRTHLP42"   "ADTRTPD42"    "ADPROBTRT42"  "ADUNABTRT42"  "ADRELTRT42"  
[331] "ADSCHTRT42"   "ADGRPTRT42"   "ADONLTRT42"   "ADPHONTRT42"  "ADAPPTRT42"  
[336] "ADTRTEXP42"   "ADBRTC42"     "ADMDVT42"     "ADFLST42"     "ADWGHD42"    
[341] "ADWTAD42"     "ADTBAC42"     "ADOFTB42"     "ADQTTB42"     "ADQTMD42"    
[346] "ADQTHP42"     "ADMOOD42"     "ADBPCK42"     "ADCHLC42"     "ADPNEU42"    
[351] "ADSHNG42"     "ADNOAP42"     "ADDSCU42"     "ADCOLN42"     "ADCLNS42"    
[356] "ADSGMD42"     "ADBLDS42"     "ADPROS42"     "ADPSAG42"     "ADUTRM42"    
[361] "ADPAP42"      "ADPAPG42"     "ADOSTP42"     "ADBNDN42"     "ADBRST42"    
[366] "ADMMGR42"     "ADCMPM42"     "ADCMPY42"     "ADLANG42"     "ADBMI42"     
[371] "DCSELIG"      "DSDIA53"      "DSA1C53"      "DSFT2153"     "DSFT2053"    
[376] "DSFT1953"     "DSFB1953"     "DSFTNV53"     "DSEY2153"     "DSEY2053"    
[381] "DSEY1953"     "DSEB1953"     "DSEYNV53"     "DSCH2153"     "DSCH2053"    
[386] "DSCH1953"     "DSCB1953"     "DSCHNV53"     "DSFL2153"     "DSFL2053"    
[391] "DSFL1953"     "DSVB1953"     "DSFLNV53"     "DSKIDN53"     "DSEYPR53"    
[396] "DSDIET53"     "DSMED53"      "DSINSU53"     "DSCPCP53"     "DSCNPC53"    
[401] "DSCPHN53"     "DSCINT53"     "DSCGRP53"     "DSCONF53"     "DSPRX53"     
[406] "DDNWRK20"     "OTHDYS20"     "OTHNDD20"     "ACCELI42"     "HAVEUS42"    
[411] "PRACTP42"     "YNOUSC42_M18" "PROVTY42_M18" "PLCTYP42"     "TMTKUS42"    
[416] "TYPEPE42"     "LOCATN42"     "HSPLAP42"     "WHITPR42"     "BLCKPR42"    
[421] "ASIANP42"     "NATAMP42"     "PACISP42"     "OTHRCP42"     "GENDRP42"    
[426] "PHNREG42"     "OFFHOU42"     "AFTHOU42"     "TREATM42"     "DECIDE42"    
[431] "EXPLOP42"     "PRVSPK42"     "DLAYCA42"     "AFRDCA42"     "DLAYDN42"    
[436] "AFRDDN42"     "DLAYPM42"     "AFRDPM42"     "CVDLAYCA53"   "CVDLAYDN53"  
[441] "CVDLAYPM53"   "EMPST31"      "EMPST42"      "EMPST53"      "RNDFLG31"    
[446] "MORJOB31"     "MORJOB42"     "MORJOB53"     "EVRWRK"       "HRWG31X"     
[451] "HRWG42X"      "HRWG53X"      "HRWGIM31"     "HRWGIM42"     "HRWGIM53"    
[456] "HRHOW31"      "HRHOW42"      "HRHOW53"      "DIFFWG31"     "DIFFWG42"    
[461] "DIFFWG53"     "NHRWG31"      "NHRWG42"      "NHRWG53"      "HOUR31"      
[466] "HOUR42"       "HOUR53"       "TEMPJB31"     "TEMPJB42"     "TEMPJB53"    
[471] "SSNLJB31"     "SSNLJB42"     "SSNLJB53"     "SELFCM31"     "SELFCM42"    
[476] "SELFCM53"     "DISVW31X"     "DISVW42X"     "DISVW53X"     "CHOIC31"     
[481] "CHOIC42"      "CHOIC53"      "INDCAT31"     "INDCAT42"     "INDCAT53"    
[486] "NUMEMP31"     "NUMEMP42"     "NUMEMP53"     "MORE31"       "MORE42"      
[491] "MORE53"       "UNION31"      "UNION42"      "UNION53"      "NWK31"       
[496] "NWK42"        "NWK53"        "CHGJ3142"     "CHGJ4253"     "YCHJ3142"    
[501] "YCHJ4253"     "STJBMM31"     "STJBYY31"     "STJBMM42"     "STJBYY42"    
[506] "STJBMM53"     "STJBYY53"     "EVRETIRE"     "OCCCAT31"     "OCCCAT42"    
[511] "OCCCAT53"     "PAYVAC31"     "PAYVAC42"     "PAYVAC53"     "SICPAY31"    
[516] "SICPAY42"     "SICPAY53"     "PAYDR31"      "PAYDR42"      "PAYDR53"     
[521] "RETPLN31"     "RETPLN42"     "RETPLN53"     "BSNTY31"      "BSNTY42"     
[526] "BSNTY53"      "JOBORG31"     "JOBORG42"     "JOBORG53"     "HELD31X"     
[531] "HELD42X"      "HELD53X"      "OFFER31X"     "OFFER42X"     "OFFER53X"    
[536] "OFREMP31"     "OFREMP42"     "OFREMP53"     "OUTFLAG31"    "OUTFLAG42"   
[541] "OUTFLAG53"    "EMPST31H"     "EMPST42H"     "EMPST53H"     "SLFCM31H"    
[546] "SLFCM42H"     "SLFCM53H"     "NMEMP31H"     "NMEMP42H"     "NMEMP53H"    
[551] "MORE31H"      "MORE42H"      "MORE53H"      "INDCT31H"     "INDCT42H"    
[556] "INDCT53H"     "OCCCT31H"     "OCCCT42H"     "OCCCT53H"     "HOUR31H"     
[561] "HOUR42H"      "HOUR53H"      "JBORG31H"     "JBORG42H"     "JBORG53H"    
[566] "UNION31H"     "UNION42H"     "UNION53H"     "BSNTY31H"     "BSNTY42H"    
[571] "BSNTY53H"     "HRWG31H"      "HRWG42H"      "HRWG53H"      "CMJHLD31"    
[576] "CMJHLD42"     "CMJHLD53"     "OFFER31H"     "OFFER42H"     "OFFER53H"    
[581] "OFEMP31H"     "OFEMP42H"     "OFEMP53H"     "PYVAC31H"     "PYVAC42H"    
[586] "PYVAC53H"     "SCPAY31H"     "SCPAY42H"     "SCPAY53H"     "PAYDR31H"    
[591] "PAYDR42H"     "PAYDR53H"     "RTPLN31H"     "RTPLN42H"     "RTPLN53H"    
[596] "FILEDR20"     "WILFIL20"     "FLSTAT20"     "FILER20"      "JTINRU20"    
[601] "JNTPID20"     "TAXFRM20"     "FOODST20"     "FOODMN20"     "FOODVL20"    
[606] "TTLP20X"      "FAMINC20"     "POVCAT20"     "POVLEV20"     "WAGEP20X"    
[611] "WAGIMP20"     "BUSNP20X"     "BUSIMP20"     "UNEMP20X"     "UNEIMP20"    
[616] "WCMPP20X"     "WCPIMP20"     "INTRP20X"     "INTIMP20"     "DIVDP20X"    
[621] "DIVIMP20"     "SALEP20X"     "SALIMP20"     "PENSP20X"     "PENIMP20"    
[626] "SSECP20X"     "SSCIMP20"     "TRSTP20X"     "TRTIMP20"     "VETSP20X"    
[631] "VETIMP20"     "IRASP20X"     "IRAIMP20"     "ALIMP20X"     "ALIIMP20"    
[636] "CHLDP20X"     "CHLIMP20"     "CASHP20X"     "CSHIMP20"     "SSIP20X"     
[641] "SSIIMP20"     "PUBP20X"      "PUBIMP20"     "OTHRP20X"     "OTHIMP20"    
[646] "HIEUIDX"      "TRIJA20X"     "TRIFE20X"     "TRIMA20X"     "TRIAP20X"    
[651] "TRIMY20X"     "TRIJU20X"     "TRIJL20X"     "TRIAU20X"     "TRISE20X"    
[656] "TRIOC20X"     "TRINO20X"     "TRIDE20X"     "MCRJA20"      "MCRFE20"     
[661] "MCRMA20"      "MCRAP20"      "MCRMY20"      "MCRJU20"      "MCRJL20"     
[666] "MCRAU20"      "MCRSE20"      "MCROC20"      "MCRNO20"      "MCRDE20"     
[671] "MCRJA20X"     "MCRFE20X"     "MCRMA20X"     "MCRAP20X"     "MCRMY20X"    
[676] "MCRJU20X"     "MCRJL20X"     "MCRAU20X"     "MCRSE20X"     "MCROC20X"    
[681] "MCRNO20X"     "MCRDE20X"     "MCDJA20"      "MCDFE20"      "MCDMA20"     
[686] "MCDAP20"      "MCDMY20"      "MCDJU20"      "MCDJL20"      "MCDAU20"     
[691] "MCDSE20"      "MCDOC20"      "MCDNO20"      "MCDDE20"      "MCDJA20X"    
[696] "MCDFE20X"     "MCDMA20X"     "MCDAP20X"     "MCDMY20X"     "MCDJU20X"    
[701] "MCDJL20X"     "MCDAU20X"     "MCDSE20X"     "MCDOC20X"     "MCDNO20X"    
[706] "MCDDE20X"     "GVAJA20"      "GVAFE20"      "GVAMA20"      "GVAAP20"     
[711] "GVAMY20"      "GVAJU20"      "GVAJL20"      "GVAAU20"      "GVASE20"     
[716] "GVAOC20"      "GVANO20"      "GVADE20"      "GVBJA20"      "GVBFE20"     
[721] "GVBMA20"      "GVBAP20"      "GVBMY20"      "GVBJU20"      "GVBJL20"     
[726] "GVBAU20"      "GVBSE20"      "GVBOC20"      "GVBNO20"      "GVBDE20"     
[731] "GVCJA20"      "GVCFE20"      "GVCMA20"      "GVCAP20"      "GVCMY20"     
[736] "GVCJU20"      "GVCJL20"      "GVCAU20"      "GVCSE20"      "GVCOC20"     
[741] "GVCNO20"      "GVCDE20"      "VAPJA20"      "VAPFE20"      "VAPMA20"     
[746] "VAPAP20"      "VAPMY20"      "VAPJU20"      "VAPJL20"      "VAPAU20"     
[751] "VAPSE20"      "VAPOC20"      "VAPNO20"      "VAPDE20"      "IHSJA20"     
[756] "IHSFE20"      "IHSMA20"      "IHSAP20"      "IHSMY20"      "IHSJU20"     
[761] "IHSJL20"      "IHSAU20"      "IHSSE20"      "IHSOC20"      "IHSNO20"     
[766] "IHSDE20"      "PUBJA20X"     "PUBFE20X"     "PUBMA20X"     "PUBAP20X"    
[771] "PUBMY20X"     "PUBJU20X"     "PUBJL20X"     "PUBAU20X"     "PUBSE20X"    
[776] "PUBOC20X"     "PUBNO20X"     "PUBDE20X"     "PEGJA20"      "PEGFE20"     
[781] "PEGMA20"      "PEGAP20"      "PEGMY20"      "PEGJU20"      "PEGJL20"     
[786] "PEGAU20"      "PEGSE20"      "PEGOC20"      "PEGNO20"      "PEGDE20"     
[791] "PDKJA20"      "PDKFE20"      "PDKMA20"      "PDKAP20"      "PDKMY20"     
[796] "PDKJU20"      "PDKJL20"      "PDKAU20"      "PDKSE20"      "PDKOC20"     
[801] "PDKNO20"      "PDKDE20"      "PNGJA20"      "PNGFE20"      "PNGMA20"     
[806] "PNGAP20"      "PNGMY20"      "PNGJU20"      "PNGJL20"      "PNGAU20"     
[811] "PNGSE20"      "PNGOC20"      "PNGNO20"      "PNGDE20"      "POGJA20"     
[816] "POGFE20"      "POGMA20"      "POGAP20"      "POGMY20"      "POGJU20"     
[821] "POGJL20"      "POGAU20"      "POGSE20"      "POGOC20"      "POGNO20"     
[826] "POGDE20"      "POEJA20"      "POEFE20"      "POEMA20"      "POEAP20"     
[831] "POEMY20"      "POEJU20"      "POEJL20"      "POEAU20"      "POESE20"     
[836] "POEOC20"      "POENO20"      "POEDE20"      "PNEJA20"      "PNEFE20"     
[841] "PNEMA20"      "PNEAP20"      "PNEMY20"      "PNEJU20"      "PNEJL20"     
[846] "PNEAU20"      "PNESE20"      "PNEOC20"      "PNENO20"      "PNEDE20"     
[851] "PRXJA20"      "PRXFE20"      "PRXMA20"      "PRXAP20"      "PRXMY20"     
[856] "PRXJU20"      "PRXJL20"      "PRXAU20"      "PRXSE20"      "PRXOC20"     
[861] "PRXNO20"      "PRXDE20"      "PRIJA20"      "PRIFE20"      "PRIMA20"     
[866] "PRIAP20"      "PRIMY20"      "PRIJU20"      "PRIJL20"      "PRIAU20"     
[871] "PRISE20"      "PRIOC20"      "PRINO20"      "PRIDE20"      "HPEJA20"     
[876] "HPEFE20"      "HPEMA20"      "HPEAP20"      "HPEMY20"      "HPEJU20"     
[881] "HPEJL20"      "HPEAU20"      "HPESE20"      "HPEOC20"      "HPENO20"     
[886] "HPEDE20"      "HPDJA20"      "HPDFE20"      "HPDMA20"      "HPDAP20"     
[891] "HPDMY20"      "HPDJU20"      "HPDJL20"      "HPDAU20"      "HPDSE20"     
[896] "HPDOC20"      "HPDNO20"      "HPDDE20"      "HPNJA20"      "HPNFE20"     
[901] "HPNMA20"      "HPNAP20"      "HPNMY20"      "HPNJU20"      "HPNJL20"     
[906] "HPNAU20"      "HPNSE20"      "HPNOC20"      "HPNNO20"      "HPNDE20"     
[911] "HPOJA20"      "HPOFE20"      "HPOMA20"      "HPOAP20"      "HPOMY20"     
[916] "HPOJU20"      "HPOJL20"      "HPOAU20"      "HPOSE20"      "HPOOC20"     
[921] "HPONO20"      "HPODE20"      "HPXJA20"      "HPXFE20"      "HPXMA20"     
[926] "HPXAP20"      "HPXMY20"      "HPXJU20"      "HPXJL20"      "HPXAU20"     
[931] "HPXSE20"      "HPXOC20"      "HPXNO20"      "HPXDE20"      "HPRJA20"     
[936] "HPRFE20"      "HPRMA20"      "HPRAP20"      "HPRMY20"      "HPRJU20"     
[941] "HPRJL20"      "HPRAU20"      "HPRSE20"      "HPROC20"      "HPRNO20"     
[946] "HPRDE20"      "INSJA20X"     "INSFE20X"     "INSMA20X"     "INSAP20X"    
[951] "INSMY20X"     "INSJU20X"     "INSJL20X"     "INSAU20X"     "INSSE20X"    
[956] "INSOC20X"     "INSNO20X"     "INSDE20X"     "PRVEV20"      "TRIEV20"     
[961] "MCREV20"      "MCDEV20"      "VAEV20"       "GVAEV20"      "GVBEV20"     
[966] "GVCEV20"      "UNINS20"      "INSCOV20"     "INSURC20"     "TRIST31X"    
[971] "TRIST42X"     "TRIST20X"     "TRIPR31X"     "TRIPR42X"     "TRIPR20X"    
[976] "TRIEX31X"     "TRIEX42X"     "TRIEX20X"     "TRILI31X"     "TRILI42X"    
[981] "TRILI20X"     "TRICH31X"     "TRICH42X"     "TRICH20X"     "MCRPD31"     
[986] "MCRPD42"      "MCRPD20"      "MCRPD31X"     "MCRPD42X"     "MCRPD20X"    
[991] "MCRPB31"      "MCRPB42"      "MCRPB20"      "MCRPHO31"     "MCRPHO42"    
[996] "MCRPHO20"     "MCDHMO31"     "MCDHMO42"     "MCDHMO20"     "MCDMC31"     
[ reached getOption("max.print") -- omitted 451 entries ]
> # View relevant variables ----------------------------------------------------
> fyc20 %>%
  +   select(DUPERSID, DLAYCA42, AGELAST, SEX, RACETHX, INSCOV20, REGION53, HIDEG, INTVLANG)
# A tibble: 27,805 × 9
DUPERSID   DLAYCA42  AGELAST SEX      RACETHX INSCOV20 REGION53 HIDEG   INTVLANG
<chr>      <dbl+lbl>   <dbl> <dbl+lb> <dbl+l> <dbl+lb> <dbl+lb> <dbl+l> <dbl+lb>
  1 2320005101 2 [2 NO]       73 2 [2 FE… 2 [2 N… 2 [2 PU… 1 [1 NO… 3 [3 H… 1 [1 EN…
                                                                               2 2320005102 2 [2 NO]       84 1 [1 MA… 2 [2 N… 2 [2 PU… 1 [1 NO… 3 [3 H… 1 [1 EN…
                                                                                                                                                            3 2320006101 1 [1 YES]      47 2 [2 FE… 1 [1 H… 3 [3 UN… 3 [3 SO… 3 [3 H… 2 [2 SP…
                                                                                                                                                                                                                                         4 2320006102 2 [2 NO]       22 1 [1 MA… 1 [1 H… 3 [3 UN… 3 [3 SO… 1 [1 N… 2 [2 SP…
                                                                                                                                                                                                                                                                                                                      5 2320006103 2 [2 NO]       21 1 [1 MA… 1 [1 H… 2 [2 PU… 3 [3 SO… 1 [1 N… 2 [2 SP…
                                                                                                                                                                                                                                                                                                                                                                                                   6 2320012102 2 [2 NO]       80 2 [2 FE… 2 [2 N… 2 [2 PU… 1 [1 NO… 3 [3 H… 1 [1 EN…
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                7 2320013101 2 [2 NO]       85 2 [2 FE… 1 [1 H… 2 [2 PU… 3 [3 SO… 1 [1 N… 2 [2 SP…
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             8 2320018101 1 [1 YES]      58 2 [2 FE… 2 [2 N… 2 [2 PU… 4 [4 WE… 3 [3 H… 1 [1 EN…
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          9 2320018102 2 [2 NO]       72 1 [1 MA… 2 [2 N… 2 [2 PU… 4 [4 WE… 3 [3 H… 1 [1 EN…
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       10 2320018103 2 [2 NO]       20 1 [1 MA… 2 [2 N… 2 [2 PU… 4 [4 WE… 1 [1 N… 1 [1 EN…
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # ℹ 27,795 more rows
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # ℹ Use `print(n = ...)` to see more rows
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > # Keep only needed variables -------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > fyc20_sub <- fyc20 %>%
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +   select(DUPERSID, VARPSU, VARSTR, PERWT20F,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +          DLAYCA42, AGELAST, SEX, RACETHX, INSCOV20, REGION53, HIDEG, INTVLANG)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > # Create variables -----------------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > fyc20x <- fyc20_sub %>%
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +   mutate(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +     DLAYCA42 = as.numeric(DLAYCA42),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +     # Convert outcome from 1/2 to 0/1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +     delay_medical = case_when(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +       DLAYCA42 == 1 ~ 1,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +       DLAYCA42 == 2 ~ 0,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +       TRUE ~ NA_real_
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +     ),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +     # Create subpopulation flag
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +     subpop = !is.na(delay_medical)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +   )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > # QC new variables
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       > fyc20x %>% count(delay_medical, DLAYCA42, subpop)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # A tibble: 5 × 4
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     delay_medical DLAYCA42 subpop     n
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <dbl>    <dbl> <lgl>  <int>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       1             0        2 TRUE   25563
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     2             1        1 TRUE    1742
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     3            NA       -8 FALSE     35
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     4            NA       -7 FALSE     19
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     5            NA       -1 FALSE    446
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > # Check regression predictors 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       > fyc20x %>% count(SEX)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # A tibble: 2 × 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     SEX              n
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <dbl+lbl>    <int>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       1 1 [1 MALE]   13258
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     2 2 [2 FEMALE] 14547
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > fyc20x %>% count(RACETHX)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # A tibble: 5 × 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     RACETHX                                            n
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <dbl+lbl>                                      <int>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       1 1 [1 HISPANIC]                                  6814
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     2 2 [2 NON-HISPANIC WHITE ONLY]                  14595
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     3 3 [3 NON-HISPANIC BLACK ONLY]                   3965
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     4 4 [4 NON-HISPANIC ASIAN ONLY]                   1436
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     5 5 [5 NON-HISPANIC OTHER RACE OR MULTIPLE RACE]   995
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > fyc20x %>% count(INSCOV20)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # A tibble: 3 × 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     INSCOV20              n
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <dbl+lbl>         <int>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       1 1 [1 ANY PRIVATE] 16056
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     2 2 [2 PUBLIC ONLY]  9539
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     3 3 [3 UNINSURED]    2210
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > fyc20x %>% count(REGION53)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # A tibble: 5 × 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     REGION53                 n
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <dbl+lbl>            <int>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       1 -1 [-1 INAPPLICABLE]   226
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     2  1 [1 NORTHEAST]      4253
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     3  2 [2 MIDWEST]        5355
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     4  3 [3 SOUTH]         10534
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     5  4 [4 WEST]           7437
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > fyc20x %>% count(HIDEG)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # A tibble: 11 × 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     HIDEG                                   n
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <dbl+lbl>                           <int>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       1 -15 [-15 CANNOT BE COMPUTED]            2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     2  -8 [-8 DK]                           134
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     3  -7 [-7 REFUSED]                       20
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     4   1 [1 NO DEGREE]                    3443
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     5   2 [2 GED]                           859
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     6   3 [3 HIGH SCHOOL DIPLOMA]          8734
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     7   4 [4 BACHELOR'S DEGREE]            4175
 8   5 [5 MASTER'S DEGREE]              2066
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     9   6 [6 DOCTORATE DEGREE]              517
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     10   7 [7 OTHER DEGREE]                 2032
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     11   8 [8 UNDER AGE 16 - INAPPLICABLE]  5823
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > fyc20x %>% count(INTVLANG)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # A tibble: 4 × 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     INTVLANG                            n
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <dbl+lbl>                       <int>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       1  1 [1 ENGLISH]                  24186
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     2  2 [2 SPANISH]                   2673
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     3  3 [3 BOTH ENGLISH AND SPANISH]   778
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     4 91 [91 OTHER LANGUAGE]            168
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > fyc20x %>% pull(AGELAST) %>% summary
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0.00   21.00   42.00   41.63   62.00   85.00 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > # Define the survey design
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       > meps_dsgn <- svydesign(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +   id = ~VARPSU,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +   strata = ~VARSTR,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +   weights = ~PERWT20F,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +   data = fyc20x,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +   nest = TRUE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         + )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > # Survey-weighted estimate (cleaning) 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       > svymean(~delay_medical, design = subset(meps_dsgn, subpop))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     mean     SE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     delay_medical 0.056799 0.0021
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > # Logistic regression: medical delay by insurance type and predictors
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       > logit_model <- svyglm(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +   delay_medical ~ AGELAST + as.factor(SEX) + as.factor(RACETHX) +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +     as.factor(INSCOV20) + as.factor(REGION53) + as.factor(HIDEG) + as.factor(INTVLANG),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +   design = subset(meps_dsgn, subpop),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +   family = quasibinomial
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         + )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Warning messages:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       1: In summary.glm(g) :
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       observations with zero weight not used for calculating dispersion
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     2: In summary.glm(glm.object) :
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       observations with zero weight not used for calculating dispersion
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > summary(logit_model)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Call:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       svyglm(formula = delay_medical ~ AGELAST + as.factor(SEX) + as.factor(RACETHX) + 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                as.factor(INSCOV20) + as.factor(REGION53) + as.factor(HIDEG) + 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                as.factor(INTVLANG), design = subset(meps_dsgn, subpop), 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              family = quasibinomial)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Survey design:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       subset(meps_dsgn, subpop)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Coefficients:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       Estimate Std. Error t value Pr(>|t|)    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     (Intercept)           -14.035109   1.213208 -11.569  < 2e-16 ***
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       AGELAST                -0.007459   0.001863  -4.003 9.77e-05 ***
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       as.factor(SEX)2         0.288630   0.056357   5.122 9.12e-07 ***
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       as.factor(RACETHX)2     0.260434   0.116316   2.239  0.02662 *  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       as.factor(RACETHX)3     0.122612   0.157102   0.780  0.43634    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     as.factor(RACETHX)4    -0.521361   0.193702  -2.692  0.00791 ** 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       as.factor(RACETHX)5     0.500232   0.196969   2.540  0.01211 *  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       as.factor(INSCOV20)2    0.117758   0.091090   1.293  0.19807    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     as.factor(INSCOV20)3    1.171740   0.103489  11.322  < 2e-16 ***
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       as.factor(REGION53)1    0.055959   0.985617   0.057  0.95480    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     as.factor(REGION53)2    0.296149   0.980773   0.302  0.76310    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     as.factor(REGION53)3    0.339129   0.974428   0.348  0.72830    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     as.factor(REGION53)4    0.365457   0.976712   0.374  0.70880    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     as.factor(HIDEG)-8     10.742041   0.807929  13.296  < 2e-16 ***
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       as.factor(HIDEG)-7     -0.209229   0.934179  -0.224  0.82308    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     as.factor(HIDEG)1      10.792075   0.722272  14.942  < 2e-16 ***
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       as.factor(HIDEG)2      11.517546   0.735832  15.652  < 2e-16 ***
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       as.factor(HIDEG)3      10.976716   0.717301  15.303  < 2e-16 ***
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       as.factor(HIDEG)4      11.073179   0.729544  15.178  < 2e-16 ***
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       as.factor(HIDEG)5      10.703545   0.734234  14.578  < 2e-16 ***
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       as.factor(HIDEG)6      10.035858   0.780436  12.859  < 2e-16 ***
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       as.factor(HIDEG)7      11.059103   0.729069  15.169  < 2e-16 ***
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       as.factor(HIDEG)8       8.988598   0.738006  12.180  < 2e-16 ***
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       as.factor(INTVLANG)2    0.355993   0.191143   1.862  0.06448 .  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     as.factor(INTVLANG)3   -0.161744   0.221407  -0.731  0.46620    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     as.factor(INTVLANG)91  -0.163080   0.547022  -0.298  0.76602    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     (Dispersion parameter for quasibinomial family taken to be 0.9974758)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Number of Fisher Scoring iterations: 12
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > #  Create and relabel tidy_model
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       > tidy_model <- tidy(logit_model) %>%
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +   mutate(term = recode(term,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `(Intercept)` = "Intercept",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `AGELAST` = "Age (last)",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(SEX)2` = "Sex: Female",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(RACETHX)2` = "Race: White",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(RACETHX)3` = "Race: Black",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(RACETHX)4` = "Race: Asian",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(RACETHX)5` = "Race: Other/Mixed",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(INSCOV20)2` = "Insurance: Public",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(INSCOV20)3` = "Insurance: Uninsured",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(REGION53)1` = "Region: Northeast",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(REGION53)2` = "Region: Midwest",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(REGION53)3` = "Region: South",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(REGION53)4` = "Region: West",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(HIDEG)-8` = "Education: DK",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(HIDEG)-7` = "Education: Refused",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(HIDEG)1` = "Education: No Degree",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(HIDEG)2` = "Education: GED",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(HIDEG)3` = "Education: HS Diploma",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(HIDEG)4` = "Education: Bachelor's",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(HIDEG)5` = "Education: Master's",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(HIDEG)6` = "Education: Doctorate",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(HIDEG)7` = "Education: Other Degree",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(HIDEG)8` = "Education: Under 16",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(INTVLANG)2` = "Interview: Spanish",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(INTVLANG)3` = "Interview: ENG & SP",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +                        `as.factor(INTVLANG)91` = "Interview: Other"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +   ))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > # View cleaned model output
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       > print(tidy_model)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # A tibble: 26 × 5
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     term                  estimate std.error statistic  p.value
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <chr>                    <dbl>     <dbl>     <dbl>    <dbl>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       1 Intercept            -14.0       1.21     -11.6    1.46e-22
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     2 Age (last)            -0.00746   0.00186   -4.00   9.77e- 5
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     3 Sex: Female            0.289     0.0564     5.12   9.12e- 7
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     4 Race: White            0.260     0.116      2.24   2.66e- 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     5 Race: Black            0.123     0.157      0.780  4.36e- 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     6 Race: Asian           -0.521     0.194     -2.69   7.91e- 3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     7 Race: Other/Mixed      0.500     0.197      2.54   1.21e- 2
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     8 Insurance: Public      0.118     0.0911     1.29   1.98e- 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     9 Insurance: Uninsured   1.17      0.103     11.3    6.67e-22
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     10 Region: Northeast      0.0560    0.986      0.0568 9.55e- 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # ℹ 16 more rows
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     # ℹ Use `print(n = ...)` to see more rows
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > library(knitr)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > library(kableExtra)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Attaching package: ‘kableExtra’
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     The following object is masked from ‘package:dplyr’:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       group_rows
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > tidy_model %>%
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +   kable(digits = 3, caption = "Survey-Weighted Logistic Regression Results") %>%
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +   kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > #Create outcome and filter valid responses (cleaning)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       > fyc20_clean <- fyc20_sub %>%
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +   mutate(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +     DLAYCA42 = as.numeric(DLAYCA42),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +     delay_medical = case_when(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +       DLAYCA42 == 1 ~ 1,  # Delayed care
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +       DLAYCA42 == 2 ~ 0,  # Did not delay
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +       TRUE ~ NA_real_
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +     )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +   ) %>%
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +   filter(!is.na(delay_medical))  # Remove missing outcomes
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > # 4. Convert variables to factors
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       > fyc20_clean <- fyc20_clean %>%
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +   mutate(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +     delay_medical = as.factor(delay_medical),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +     SEX = as.factor(SEX),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +     RACETHX = as.factor(RACETHX),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +     INSCOV20 = as.factor(INSCOV20),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +     REGION53 = as.factor(REGION53),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +     HIDEG = as.factor(HIDEG),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +     INTVLANG = as.factor(INTVLANG)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +   )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > # smple for faster processing (optional)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       > set.seed(42)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > fyc20_sample <- fyc20_clean %>% sample_n(500)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > # 5. One-hot encode categorical variables
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       > #One-hot encode using model.matrix (faster than dummyVars)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       > #5. One-hot encode using model.matrix on the sample
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       > x_data <- model.matrix(delay_medical ~ . - 1, data = fyc20_sample) %>% as.data.frame()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > y_data <- fyc20_sample$delay_medical
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > # 6. Split data into training and testing sets
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       > set.seed(123)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > train_index <- createDataPartition(y_data, p = 0.7, list = FALSE)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > x_train <- x_data[train_index, ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > x_test  <- x_data[-train_index, ]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > y_train <- y_data[train_index]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > y_test  <- y_data[-train_index]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > # 7. Run KNN (k = 3)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       > k <- 3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > y_pred <- knn(train = x_train, test = x_test, cl = y_train, k = k)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > # 8. Evaluate model performance
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       > conf_matrix <- confusionMatrix(y_pred, y_test)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     > print(conf_matrix)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Confusion Matrix and Statistics
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Reference
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Prediction   0   1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     0 139   8
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     1   2   0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Accuracy : 0.9329        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     95% CI : (0.88, 0.9673)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     No Information Rate : 0.9463        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     P-Value [Acc > NIR] : 0.8214        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Kappa : -0.0219       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Mcnemar's Test P-Value : 0.1138        
                                        
            Sensitivity : 0.9858        
            Specificity : 0.0000        
         Pos Pred Value : 0.9456        
         Neg Pred Value : 0.0000        
             Prevalence : 0.9463        
         Detection Rate : 0.9329        
   Detection Prevalence : 0.9866        
      Balanced Accuracy : 0.4929        
                                        
       'Positive' Class : 0             
                                        
> # 9. (Optional) Tune k from 1 to 20
> accuracy <- c()
> for (k in 1:20) {
+   pred_k <- knn(train = x_train, test = x_test, cl = y_train, k = k)
+   acc <- mean(pred_k == y_test)
+   accuracy <- c(accuracy, acc)
+ }
> # Plot accuracy by k
> plot(1:20, accuracy, type = "b", pch = 19,
+      xlab = "Number of Neighbors (k)",
+      ylab = "Accuracy",
+      main = "KNN Accuracy by k (MEPS 2020)")
